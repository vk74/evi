# Version: 1.1.1
# Purpose: Valkey server config for evi-state (AOF + RDB hybrid persistence).
# File: valkey.conf (backend/deploy)
# Logic: Data dir /data (mounted volume). Password injected at runtime via --include (not in this file).
#
# Changes in v1.1.0:
# - Added maxmemory 1gb to prevent unbounded disk usage by dump.rdb and appendonly.aof
# - Added maxmemory-policy volatile-lru: evicts only keys with TTL (caches), never stream/queue keys
#
# Changes in v1.0.0:
# - Initial config: hybrid persistence, internal bind
#

# Listen on all interfaces inside the container (no host port published)
bind 0.0.0.0
port 6379

# --- Memory limit ---
# Bounds in-memory dataset to ~512 MB, which also bounds dump.rdb and appendonly.aof on disk.
# volatile-lru evicts least-recently-used keys that have a TTL (cache:db:*, op:*).
# Keys without TTL (stream:tasks:*) are never evicted â€” queue entries are protected.
maxmemory 1gb
maxmemory-policy volatile-lru

# Persistence directory (mounted named volume evi_state_data)
dir /data

# --- RDB (snapshots) ---
# Snapshot if 1 key changed in 900s, or 10 in 300s, or 10000 in 60s
save 900 1
save 300 10
save 60 10000
dbfilename dump.rdb

# --- AOF (append-only log for crash recovery) ---
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
# Hybrid: base AOF file uses RDB format for compact and fast restarts
aof-use-rdb-preamble yes
# Rewrite AOF when it grows 100% beyond its last rewrite size, minimum 64 MB.
# This prevents unbounded AOF growth; old log entries are compacted automatically.
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# requirepass is set at runtime via --include /tmp/valkey-auth.conf (from Podman secret)
