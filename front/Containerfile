#
# version: 1.2.0
# Purpose: Frontend container build for serving the SPA in production. FRONTEND file: Containerfile
# Logic: Multi-stage build (Node for build → Nginx for runtime). Stateless, serves compiled assets from /usr/share/nginx/html.
#
# Changes in v1.2.0:
# - ARG NODE_MEMORY_MB and ENV NODE_OPTIONS for Node heap limit during build (prevents OOM/SIGKILL); release.sh passes 8192 or 16384 based on host RAM.
#

# =========================
# Build stage
# =========================
FROM docker.io/library/node:18-alpine AS build

WORKDIR /app

# Install dependencies first (leverage layer cache)
COPY package-lock.json package.json ./
COPY babel.config.js ./
COPY tsconfig.json ./
COPY jsconfig.json ./

RUN --mount=type=cache,target=/root/.npm \
    npm ci --no-audit --fund=false --progress=false

# Copy source code
COPY ./ .

# Accept build argument for API URL (defaults to localhost for local dev)
ARG VUE_APP_API_URL=http://localhost:3000
ENV VUE_APP_API_URL=${VUE_APP_API_URL}

# Optional build flags (e.g. --no-parallel to save memory)
ARG BUILD_FLAGS=""

# Node heap limit for npm build (MB); passed by release.sh from host RAM (8–16 GB range)
ARG NODE_MEMORY_MB=16384
ENV NODE_OPTIONS="--max-old-space-size=${NODE_MEMORY_MB}"

# Build production assets (cache webpack/babel caches)
RUN --mount=type=cache,target=/app/node_modules/.cache \
    npm run build -- ${BUILD_FLAGS}


# =========================
# Runtime stage
# =========================
FROM docker.io/library/nginx:alpine

# Non-root user for security
# (Nginx in alpine runs as root by default; we keep root to bind 80 but use minimal surface.)

# Copy built assets
COPY --from=build /app/dist /usr/share/nginx/html

# Replace default nginx config to enable SPA routing
COPY ./nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

# Healthcheck (basic)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD wget -qO- http://127.0.0.1/ || exit 1

CMD ["nginx", "-g", "daemon off;"]



