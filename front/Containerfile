#
# version: 1.5.1
# Purpose: Frontend container build for serving the SPA in production. FRONTEND file: Containerfile
# Logic: Multi-stage build (Node for build with Vite â†’ Nginx for runtime). Stateless, serves compiled assets from /usr/share/nginx/html.
#
# Changes in v1.5.1:
# - Build stage uses $BUILDPLATFORM to run natively on host architecture (no QEMU emulation)
# - Fixes esbuild Go runtime crash (lfstack.push) when cross-compiling under QEMU
# - Runtime stage (nginx) remains multi-arch for target platforms
# - Added --omit=dev note: not applicable since vite is in devDependencies
#
# Changes in v1.5.0:
# - Migrated from Vue CLI (webpack) to Vite build
# - Removed babel.config.js and jsconfig.json COPY steps (no longer exist)
# - Added index.html and vite.config.ts to COPY
# - Replaced VUE_APP_API_URL with VITE_API_URL
# - Removed NODE_MEMORY_MAIN_MB/NODE_MEMORY_CHILD_MB (Vite+esbuild uses much less memory)
# - Removed BUILD_FLAGS (no longer needed)
#
# Changes in v1.4.0:
# - Updated build stage base image from node:18-alpine to node:24-alpine (aligned with project Node.js 24 requirement)
#

# =========================
# Build stage (runs on host architecture to avoid QEMU; output is arch-independent static files)
# =========================
FROM --platform=$BUILDPLATFORM docker.io/library/node:24-alpine AS build

WORKDIR /app

# Install dependencies first (leverage layer cache)
COPY package-lock.json package.json ./
COPY tsconfig.json ./
COPY vite.config.ts ./
COPY index.html ./

RUN --mount=type=cache,target=/root/.npm \
    npm ci --no-audit --fund=false --progress=false --loglevel=error

# Copy source code
COPY ./ .

# Accept build argument for API URL (defaults to localhost for local dev)
ARG VITE_API_URL=http://localhost:3000
ENV VITE_API_URL=${VITE_API_URL}

# Build production assets (cache Vite caches)
RUN --mount=type=cache,target=/app/node_modules/.vite \
    npm run build:skip-tsc


# =========================
# Runtime stage
# =========================
FROM docker.io/library/nginx:alpine

# Copy built assets
COPY --from=build /app/dist /usr/share/nginx/html

# Replace default nginx config to enable SPA routing
COPY ./nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

# Healthcheck (basic)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD wget -qO- http://127.0.0.1/ || exit 1

CMD ["nginx", "-g", "daemon off;"]
