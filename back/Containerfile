# Version: 1.3.1
# Description: Multi-stage container build for the evi backend.
# Creates a build stage to compile TypeScript and a lean runtime stage.
# Backend file: Containerfile
#
# Changes in v1.3.1:
# - Removed baking JWT signing keys into the image; keys must be mounted via secrets/volumes in production

# =========================
# Build stage
# =========================
FROM node:20-alpine AS build

WORKDIR /app

# Copy package files and install all dependencies (including dev)
COPY package*.json ./
RUN npm ci

# Copy the rest of the source code
COPY tsconfig.json ./
COPY ./src ./src

# Build the application (npm run build will correctly use the tsc from node_modules)
RUN npm run build


# =========================
# Runtime stage
# =========================
FROM node:20-alpine

# Set production environment
ENV NODE_ENV=production

WORKDIR /app

# Copy only production dependencies
COPY package*.json ./
RUN npm ci --omit=dev

# Copy the compiled code from the build stage
COPY --from=build /app/dist ./dist

# Create a symlink for module-alias to work correctly.
# The application uses '@/' which points to 'src/', so we link 'src' to 'dist'
# where the compiled code and keys now reside.
RUN ln -s /app/dist /app/src


# Expose the application port
EXPOSE 3000

# Command to run the application
CMD ["node", "dist/server.js"]



